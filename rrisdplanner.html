<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RRISD 4-Year Graduation Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Style for PNG export to ensure background is captured */
        .exporting-png {
            background-color: #f9fafb; /* Match the wrapper background */
        }
        /* Basic font setup */
        body {
            font-family: 'Inter', sans-serif; /* Example font */
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
// Ensure React and ReactDOM are available from CDN
const { useState, useEffect, useCallback, useMemo } = React;

// --- Data (Graduation Plans, Endorsements, Subject Map - Course Data is now loaded) ---

// NOTE: coursesData constant is REMOVED. It will be loaded dynamically.

const graduationPlansData = {
  foundation: {
    name: "Foundation Plan",
    totalCredits: 23, // Using 23 based on RRISD chart
    requirements: { ELA: 4, Math: 3, Science: 3, SocialStudies: 4, LOTE: 2, FineArts: 1, PE: 1, Electives: 5 }
  },
  foundationEndorsement: {
    name: "Foundation Plan + Endorsement",
    totalCredits: 27, // Using 27 based on RRISD chart
    requirements: { ELA: 4, Math: 4, Science: 4, SocialStudies: 4, LOTE: 2, FineArts: 1, PE: 1, Electives: 7 }
  },
  dla: {
    name: "Distinguished Level of Achievement (DLA)",
    totalCredits: 27, // Using 27 based on RRISD chart
    requirements: { ELA: 4, Math: 4, Science: 4, SocialStudies: 4, LOTE: 2, FineArts: 1, PE: 1, Electives: 7 },
    specificCourses: ['ALG2', 'ALG2ADV'] // Must include Algebra II (or its advanced version)
  }
};

// Simplified Endorsement Check - Focuses on having *some* key courses from the area
const endorsementsData = {
  STEM: {
    name: "STEM",
    description: "Science, Technology, Engineering, & Math. Requires specific sequences or credits in CTE STEM fields, Math, or Science.",
    keyCourses: ['ALG2', 'ALG2ADV', 'CHEM', 'CHEMADV', 'PHYS', 'PHYS1AP', 'CSAP', 'CSP', 'PRECALADV', 'CALCAB', 'CALCBC'],
    minAdvanced: 1
  },
  BusinessIndustry: {
    name: "Business & Industry",
    description: "Requires specific sequences in CTE Business/Industry fields or specific English paths.",
    keyCourses: ['PRINBMF', 'BIM1', 'PRINHOSP', 'CULIARTS', 'PRINARCH', 'ARCHDES1', 'ECO', 'ECOAPMAC', 'ECOAPMIC']
  },
  PublicService: {
    name: "Public Service",
    description: "Requires specific sequences in CTE Public Service fields or JROTC.",
    keyCourses: ['PRINLAW', 'LAWENF1', 'PRINHSCI', 'MEDTERM', 'HSCI_THEORY', 'ANATPHYS', 'JROTC1'] // Added Health Sci courses
  },
  ArtsHumanities: {
    name: "Arts & Humanities",
    description: "Requires sequences in Social Studies, LOTE, Fine Arts, or English.",
    keyCourses: ['WGEO', 'WHIST', 'USHIST', 'GOVT', 'ECO', 'SPAN1', 'SPAN2', 'SPAN3ADV', 'SPANLANGAP', 'ART1', 'BAND1', 'THEATER1', 'ENG4', 'ENG4AP', 'CW']
  },
  Multidisciplinary: {
    name: "Multidisciplinary Studies",
    description: "Requires 4x4 core credits (incl. Chem/Phys & Eng IV) OR 4 Adv courses (AP/IB/Dual Credit).",
    keyCourses: ['ENG4', 'ENG4AP', 'CHEM', 'CHEMADV', 'PHYS', 'PHYS1AP'] // Core check mostly handles this
  }
};

// Mapping subjects to requirement keys in graduationPlansData
const subjectMap = {
    'ELA': 'ELA',
    'Math': 'Math',
    'Science': 'Science',
    'Social Studies': 'SocialStudies',
    'LOTE': 'LOTE',
    'Fine Arts': 'FineArts',
    'PE': 'PE',
    'CTE/Elective': 'Electives',
    'Elective': 'Electives',
};

// --- Utility Functions ---
// NOTE: These functions now need access to the loaded course data (`allCoursesData`)
// They are defined inside the App component or accept the data as an argument.

// --- Components ---

// Displays a message box for warnings/errors
const MessageBox = ({ messages, clearMessages }) => {
    if (!messages || messages.length === 0) return null;

    return (
        <div className="fixed bottom-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg shadow-lg z-50 max-w-sm">
            <div className="flex justify-between items-start">
                <div>
                    <strong className="font-bold block">Alert!</strong>
                    {messages.map((msg, index) => (
                        <span key={index} className="block sm:inline">{msg}</span>
                    ))}
                </div>
                <button onClick={clearMessages} className="ml-4 text-red-500 hover:text-red-700 font-bold text-2xl leading-none">&times;</button>
            </div>
        </div>
    );
};

// Displays a single course card (used in YearPlan and MiddleSchoolCredits)
const CourseCard = ({ course, onRemove, showRemoveButton = true }) => (
    <div className="bg-white p-2 mb-2 rounded-md shadow border border-gray-200 flex justify-between items-center group">
        <div>
            <span className="font-medium text-sm text-gray-800">{course.name}</span>
            <span className="text-xs text-gray-500 ml-2">({course.credits} cr)</span>
             {course.weighted && <span title="Weighted Course" className="ml-1 text-xs bg-yellow-200 text-yellow-800 px-1 rounded">W</span>}
             {course.isAP && <span title="AP Course" className="ml-1 text-xs bg-blue-200 text-blue-800 px-1 rounded">AP</span>}
             {/* Add indicators for IB, Dual Credit etc. if needed */}
        </div>
        {showRemoveButton && (
            <button
                onClick={onRemove}
                className="text-red-500 hover:text-red-700 text-xs font-bold opacity-0 group-hover:opacity-100 transition-opacity px-1"
                aria-label={`Remove ${course.name}`}
            >
                &times;
            </button>
        )}
    </div>
);

// Generic Modal for selecting courses (used for YearPlan and MiddleSchoolCredits)
const CourseSelector = ({ title, availableCourses, onSelectCourse, onClose, showGradeFilter = false }) => {
    const [searchTerm, setSearchTerm] = useState('');
    const [selectedSubject, setSelectedSubject] = useState('All');
    const [selectedGrade, setSelectedGrade] = useState('All'); // Added for potential grade filtering

    const grades = useMemo(() => {
        if (!showGradeFilter) return [];
        const levels = new Set();
        // Ensure availableCourses is an array before processing
        if (Array.isArray(availableCourses)) {
            availableCourses.forEach(c => c?.gradeLevels?.forEach(lvl => levels.add(lvl)));
        }
        return ['All', ...Array.from(levels).sort((a, b) => a - b)];
    }, [availableCourses, showGradeFilter]);

    const filteredCourses = useMemo(() => {
        // Ensure availableCourses is an array before filtering
        if (!Array.isArray(availableCourses)) {
            console.error("availableCourses is not an array:", availableCourses);
            return [];
        }
        return availableCourses
            .filter(course =>
                course && // Ensure course object exists
                (selectedSubject === 'All' || course.subject === selectedSubject) &&
                (selectedGrade === 'All' || !showGradeFilter || (course.gradeLevels && course.gradeLevels.includes(parseInt(selectedGrade)))) && // Check gradeLevels exists
                course.name && course.name.toLowerCase().includes(searchTerm.toLowerCase()) // Check name exists
            )
            .sort((a, b) => a.name.localeCompare(b.name));
    }, [availableCourses, searchTerm, selectedSubject, selectedGrade, showGradeFilter]);

    const subjects = useMemo(() => {
        // Ensure availableCourses is an array before mapping
        if (!Array.isArray(availableCourses)) return ['All'];
        return ['All', ...new Set(availableCourses.map(c => c?.subject).filter(Boolean).sort())]; // Filter out undefined subjects
    }, [availableCourses]);


    return (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-40 flex justify-center items-center p-4">
            <div className="relative bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col">
                <div className="flex justify-between items-center p-4 border-b">
                    <h3 className="text-lg font-semibold text-gray-800">{title}</h3>
                    <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
                </div>

                 <div className="p-4 border-b flex flex-col sm:flex-row gap-2 items-center">
                     <input
                         type="text"
                         placeholder="Search courses..."
                         value={searchTerm}
                         onChange={(e) => setSearchTerm(e.target.value)}
                         className="flex-grow p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                     />
                     <select
                         value={selectedSubject}
                         onChange={(e) => setSelectedSubject(e.target.value)}
                         className="p-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 w-full sm:w-auto"
                     >
                         {subjects.map(subject => (
                             <option key={subject} value={subject}>{subject}</option>
                         ))}
                     </select>
                      {showGradeFilter && (
                         <select
                             value={selectedGrade}
                             onChange={(e) => setSelectedGrade(e.target.value)}
                             className="p-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 w-full sm:w-auto"
                         >
                             {grades.map(grade => (
                                 <option key={grade} value={grade}>{grade === 'All' ? 'All Grades' : `Grade ${grade}`}</option>
                             ))}
                         </select>
                      )}
                 </div>


                <div className="overflow-y-auto p-4 flex-grow">
                    {filteredCourses.length > 0 ? (
                        <ul className="space-y-2">
                            {filteredCourses.map(course => (
                                <li key={course.id} className="p-3 bg-gray-50 rounded-md hover:bg-blue-50 border border-gray-200 flex justify-between items-start cursor-pointer" onClick={() => onSelectCourse(course.id)}>
                                    <div>
                                        <span className="font-medium text-gray-900">{course.name}</span>
                                        <span className="text-xs text-gray-600 ml-2">({course.credits} cr) - {course.subject}</span>
                                        <p className="text-xs text-gray-500 mt-1">{course.description || 'No description available.'}</p>
                                    </div>
                                     <button
                                         onClick={(e) => { e.stopPropagation(); onSelectCourse(course.id); }}
                                         className="ml-2 px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 flex-shrink-0"
                                     >
                                         Add
                                     </button>
                                </li>
                            ))}
                        </ul>
                    ) : (
                        <p className="text-center text-gray-500">No courses match your criteria.</p>
                    )}
                </div>
                 <div className="p-4 border-t text-right">
                     <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Close</button>
                 </div>
            </div>
        </div>
    );
};

// Displays the plan for a single year
// Needs access to findCourseById and checkPrerequisites (or the data needed for them)
const YearPlan = ({
    year,
    selectedCoursesInYear,
    allCourses, // Now the full loaded dataset
    middleSchoolCredits,
    selectedCoursesByYear,
    addCourse,
    removeCourse,
    setWarnings,
    findCourseById, // Pass helper function
    checkPrerequisites // Pass helper function
}) => {
    const [showSelector, setShowSelector] = useState(false);

    // Get full course objects for courses selected in this specific year
    const coursesInYear = selectedCoursesInYear.map(findCourseById).filter(Boolean);

     // Filter available courses for the selector for *this* year
     const availableCoursesForSelector = useMemo(() => {
         // Combine all selected IDs (MS + all HS years) to check for already selected
         const allSelectedIds = new Set([...middleSchoolCredits, ...Object.values(selectedCoursesByYear).flat()]);

         // Filter the master list of all courses
         return allCourses.filter(course => {
             // Basic checks
             if (!course || !course.gradeLevels || !course.id || !course.name) return false;

             // Check grade level eligibility for the current year plan
             if (!course.gradeLevels.includes(year)) {
                 return false;
             }
             // Check if already selected (anywhere, including MS)
             if (allSelectedIds.has(course.id)) {
                  return false;
             }
             // Check prerequisites *before* showing in the list
             // Pass allCoursesData to checkPrerequisites here
             const prereqCheckResult = checkPrerequisites(course.id, selectedCoursesByYear, middleSchoolCredits, year, allCourses);
             if (!prereqCheckResult.met) {
                 return false; // Don't show if prerequisites aren't met
             }
             return true; // If all checks pass, include the course
         });
     }, [allCourses, year, middleSchoolCredits, selectedCoursesByYear, checkPrerequisites]); // Dependencies


    const handleAddCourse = (courseId) => {
        const course = findCourseById(courseId);
        if (!course) return;

        // Prerequisite check is handled by filtering logic above.
        // Add the course via the callback passed from App
        addCourse(year, courseId);
        setShowSelector(false); // Close selector on successful add

        // Optional: Check for co-requisite warnings after adding
        if (course.coRequisites && course.coRequisites.length > 0) {
             const currentYearCoursesPlusNew = new Set([...(selectedCoursesByYear[year] || []), courseId]); // Include the newly added course
             const metCoReqs = course.coRequisites.every(reqId => currentYearCoursesPlusNew.has(reqId));
             if (!metCoReqs) {
                 const coReqNames = course.coRequisites.map(id => findCourseById(id)?.name || id).join(', ');
                 setWarnings(prev => [...new Set([...prev, `Co-requisite suggested for ${course.name}: ${coReqNames} in Grade ${year}`])]);
             }
        }
    };

    return (
        <div className="bg-gray-100 p-4 rounded-lg shadow-md min-h-[200px] flex flex-col">
            <h3 className="text-lg font-semibold mb-3 text-gray-700 border-b pb-2">Grade {year}</h3>
            <div className="space-y-1 min-h-[100px] flex-grow">
                {coursesInYear.length > 0 ? (
                    coursesInYear.map(course => (
                        <CourseCard
                            key={course.id}
                            course={course}
                            onRemove={() => removeCourse(year, course.id)}
                        />
                    ))
                ) : (
                    <p className="text-sm text-gray-500 text-center pt-4">No courses added yet.</p>
                )}
            </div>
            <button
                onClick={() => setShowSelector(true)}
                className="mt-3 w-full px-3 py-1.5 bg-green-500 text-white text-sm rounded-md hover:bg-green-600 transition duration-150 ease-in-out"
            >
                + Add Course
            </button>

            {showSelector && (
                <CourseSelector
                    title={`Add Course for Grade ${year}`}
                    availableCourses={availableCoursesForSelector}
                    onSelectCourse={handleAddCourse}
                    onClose={() => setShowSelector(false)}
                    showGradeFilter={false} // Grade is fixed for YearPlan selector
                />
            )}
        </div>
    );
};

// Component to manage Middle School Credits
// Needs access to findCourseById and allCourses data
const MiddleSchoolCredits = ({
    middleSchoolCredits,
    addMiddleSchoolCredit,
    removeMiddleSchoolCredit,
    allCourses, // Pass the loaded course data
    findCourseById // Pass the helper function
}) => {
    const [showSelector, setShowSelector] = useState(false);

    // Get full course objects for selected MS credits
    const msCourses = middleSchoolCredits.map(findCourseById).filter(Boolean);

    // Filter courses potentially available in Middle School
    const availableCoursesForSelector = useMemo(() => {
        const selectedIds = new Set(middleSchoolCredits);
        // Filter from the master list of all courses
        return allCourses.filter(course =>
            course && // Ensure course object exists
            !selectedIds.has(course.id) && // Not already selected
            (course.availableInMiddleSchool === true || // Explicitly flagged
             (course.gradeLevels?.includes(9) && (!course.prerequisites || course.prerequisites.length === 0))) // Or Grade 9 with no prereqs
        );
    }, [allCourses, middleSchoolCredits]); // Depend on the full course list and selected MS credits

    const handleAddCredit = (courseId) => {
        addMiddleSchoolCredit(courseId);
        setShowSelector(false); // Close after adding
    };

    return (
        <div className="mb-6 p-4 bg-indigo-50 rounded-lg shadow">
            <h2 className="text-xl font-semibold text-indigo-800 mb-3">Middle School Credits</h2>
            <p className="text-sm text-gray-600 mb-3">Add any high school credits earned before Grade 9 (e.g., Algebra I, Spanish I/II).</p>
            <div className="space-y-1 mb-3 min-h-[40px]">
                {msCourses.length > 0 ? (
                    msCourses.map(course => (
                        <CourseCard
                            key={course.id}
                            course={course}
                            onRemove={() => removeMiddleSchoolCredit(course.id)}
                        />
                    ))
                ) : (
                    <p className="text-sm text-gray-500">No middle school credits added.</p>
                )}
            </div>
            <button
                onClick={() => setShowSelector(true)}
                className="px-3 py-1.5 bg-indigo-500 text-white text-sm rounded-md hover:bg-indigo-600 transition duration-150 ease-in-out"
            >
                + Add Middle School Credit
            </button>

            {showSelector && (
                <CourseSelector
                    title="Select Middle School Credits"
                    availableCourses={availableCoursesForSelector}
                    onSelectCourse={handleAddCredit}
                    onClose={() => setShowSelector(false)}
                    showGradeFilter={false} // Grade filter not relevant here
                />
            )}
        </div>
    );
};


// Displays graduation progress
const GraduationProgress = ({ credits, plan }) => {
    if (!plan) return <div className="p-4 bg-blue-50 rounded-lg shadow"><p className="text-center text-gray-600">Select a Graduation Plan</p></div>;

    const requirements = plan.requirements;
    const totalRequired = plan.totalCredits;

    // Calculate remaining elective need based on total requirement vs current total in *required* categories
     const currentTotalInRequiredCategories = Object.entries(credits)
         .filter(([key]) => key !== 'Electives' && key !== 'Total' && requirements[key] !== undefined)
         // Sum credits applied to required categories, capped at the required amount for each category
         .reduce((sum, [key, value]) => sum + Math.min(value, requirements[key]), 0);

     // Calculate the elective credits needed to reach the total plan credits
     const requiredElectives = Math.max(0, totalRequired - currentTotalInRequiredCategories);
     const electiveProgress = credits.Electives; // Use directly calculated electives from calculateCredits

    return (
        <div className="p-4 bg-blue-50 rounded-lg shadow h-full">
            <h3 className="text-lg font-semibold mb-3 text-blue-800">Graduation Progress ({plan.name})</h3>
            <div className="space-y-2">
                {Object.entries(requirements).map(([subjectKey, required]) => {
                    const current = credits[subjectKey] || 0;
                    const isMet = current >= required;
                    // Special handling for electives display
                    if (subjectKey === 'Electives') {
                         const displayRequired = requiredElectives; // Show calculated need
                         const displayCurrent = electiveProgress;
                         // Elective requirement is met if the earned electives meet or exceed the calculated need
                         const displayIsMet = displayCurrent >= displayRequired;
                         return (
                             <div key={subjectKey} className="text-sm">
                                 <span className="font-medium">{subjectKey}:</span> {displayCurrent.toFixed(1)} / {displayRequired.toFixed(1)} Credits Needed
                                 <span className={`ml-2 px-1.5 py-0.5 rounded text-xs ${displayIsMet ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800'}`}>
                                     {displayIsMet ? 'Met' : 'In Progress'} {/* Changed 'Needed' to 'In Progress' for clarity */}
                                 </span>
                             </div>
                         );
                    }

                    // Regular subject display
                    return (
                        <div key={subjectKey} className="text-sm">
                            <span className="font-medium">{subjectKey}:</span> {current.toFixed(1)} / {required.toFixed(1)} Credits
                            <span className={`ml-2 px-1.5 py-0.5 rounded text-xs ${isMet ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}`}>
                                {isMet ? 'Met' : 'Needed'}
                            </span>
                        </div>
                    );
                })}
                <div className="text-sm font-semibold pt-2 border-t mt-2">
                    Total: {credits.Total.toFixed(1)} / {totalRequired.toFixed(1)} Credits
                     <span className={`ml-2 px-1.5 py-0.5 rounded text-xs ${credits.Total >= totalRequired ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}`}>
                         {credits.Total >= totalRequired ? 'Met' : 'Needed'}
                     </span>
                </div>
            </div>
        </div>
    );
};

// Displays DLA status and guidance
// Needs access to findCourseById
const DLAGuidance = ({ selectedCoursesByYear, middleSchoolCredits, planType, findCourseById }) => {
     if (planType !== 'dla') return null; // Only show for DLA plan

    const allSelectedIds = useMemo(() => new Set([...middleSchoolCredits, ...Object.values(selectedCoursesByYear).flat()]), [middleSchoolCredits, selectedCoursesByYear]);
    const hasAlgebra2 = graduationPlansData.dla.specificCourses.some(id => allSelectedIds.has(id));
    // Use findCourseById passed from App
    const algebra2Course = findCourseById('ALG2') || findCourseById('ALG2ADV');

    return (
        <div className="p-4 bg-purple-50 rounded-lg shadow mt-4 h-full">
            <h3 className="text-lg font-semibold mb-2 text-purple-800">DLA Status</h3>
            <p className={`text-sm ${hasAlgebra2 ? 'text-green-700' : 'text-red-700'}`}>
                {hasAlgebra2
                    ? '✓ Algebra II requirement met.'
                    : `✗ Algebra II requirement NOT met. Consider adding "${algebra2Course?.name || 'Algebra II'}".`
                }
            </p>
             {/* Add checks for 4 Math & 4 Science if needed, though GraduationProgress covers credit counts */}
        </div>
    );
};

// Displays potential endorsements (Simplified Check)
const EndorsementTracker = ({ selectedCoursesByYear, middleSchoolCredits, planType }) => {
     if (planType === 'foundation') return null; // No endorsements for basic foundation

    const allSelectedIds = useMemo(() => new Set([...middleSchoolCredits, ...Object.values(selectedCoursesByYear).flat()]), [middleSchoolCredits, selectedCoursesByYear]);

    const potentialEndorsements = useMemo(() => {
        return Object.entries(endorsementsData)
            .map(([key, data]) => {
                // Simplified Check: Does the student have at least one 'key' course for this endorsement?
                const hasKeyCourse = data.keyCourses.some(courseId => allSelectedIds.has(courseId));
                // More complex logic needed here for sequence validation in a real app
                return hasKeyCourse ? data.name : null;
            })
            .filter(Boolean);
    }, [allSelectedIds]);


    return (
        <div className="p-4 bg-yellow-50 rounded-lg shadow mt-4 h-full">
            <h3 className="text-lg font-semibold mb-2 text-yellow-800">Potential Endorsements</h3>
            {potentialEndorsements.length > 0 ? (
                <ul className="list-disc list-inside space-y-1 text-sm">
                    {potentialEndorsements.map(name => <li key={name}>{name}</li>)}
                </ul>
            ) : (
                <p className="text-sm text-gray-600">No specific endorsements strongly indicated yet based on key courses. Select more courses, especially advanced/CTE electives.</p>
            )}
             <p className="text-xs text-gray-500 mt-2">(Note: This is a simplified check based on key courses. Refer to the official RRISD catalog for full sequence requirements.)</p>
        </div>
    );
};


// --- Main App Component ---

function App() {
    // --- State ---
    const [selectedPlanType, setSelectedPlanType] = useState('dla'); // Default to DLA
    const [selectedCourses, setSelectedCourses] = useState({ 9: [], 10: [], 11: [], 12: [] });
    const [middleSchoolCredits, setMiddleSchoolCredits] = useState([]);
    const [warnings, setWarnings] = useState([]);
    const [isDataLoaded, setIsDataLoaded] = useState(false); // Tracks if initial localStorage load attempt is done
    const [isClient, setIsClient] = useState(false);

    // State for loaded course data
    const [allCoursesData, setAllCoursesData] = useState([]); // Holds data from JSON files
    const [isLoading, setIsLoading] = useState(true); // Tracks if JSON data is loading
    const [loadingError, setLoadingError] = useState(null); // Stores JSON loading errors

    // --- Effects ---

    // Effect to mark client-side rendering and load html2canvas script
    useEffect(() => {
       setIsClient(true);
       const scriptId = 'html2canvas-script';
       if (!document.getElementById(scriptId)) {
           const script = document.createElement('script');
           script.id = scriptId;
           script.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
           script.async = true;
           script.onload = () => console.log('html2canvas loaded successfully.');
           script.onerror = () => console.error('Failed to load html2canvas script.');
           document.body.appendChild(script);
       }
     }, []);

    // Effect to load saved selections from localStorage
    useEffect(() => {
        if (isClient && typeof window !== 'undefined' && window.localStorage) {
            const savedPlan = localStorage.getItem('graduationPlan');
            const savedCourses = localStorage.getItem('selectedCourses');
            const savedMsCredits = localStorage.getItem('middleSchoolCredits');

            if (savedPlan) setSelectedPlanType(savedPlan);
            if (savedCourses) {
                try {
                     const parsedCourses = JSON.parse(savedCourses);
                     if (typeof parsedCourses === 'object' && parsedCourses !== null && [9,10,11,12].every(y => Array.isArray(parsedCourses[y]))) {
                         setSelectedCourses(parsedCourses);
                     } else { localStorage.removeItem('selectedCourses'); }
                } catch (e) { localStorage.removeItem('selectedCourses'); }
            }
             if (savedMsCredits) {
                 try {
                     const parsedMsCredits = JSON.parse(savedMsCredits);
                     if (Array.isArray(parsedMsCredits)) {
                         setMiddleSchoolCredits(parsedMsCredits);
                     } else { localStorage.removeItem('middleSchoolCredits'); }
                 } catch (e) { localStorage.removeItem('middleSchoolCredits'); }
             }
        }
         setIsDataLoaded(true); // Mark initial load attempt complete
    }, [isClient]);

    // Effect to save selections to localStorage
    useEffect(() => {
         if (isClient && isDataLoaded && typeof window !== 'undefined' && window.localStorage) {
             localStorage.setItem('graduationPlan', selectedPlanType);
             localStorage.setItem('selectedCourses', JSON.stringify(selectedCourses));
             localStorage.setItem('middleSchoolCredits', JSON.stringify(middleSchoolCredits));
         }
    }, [selectedPlanType, selectedCourses, middleSchoolCredits, isDataLoaded, isClient]);

    // Effect to fetch course data from JSON files on mount
    useEffect(() => {
        const fetchCourseData = async () => {
            // Use the filenames provided by the user
            const files = [
                'ela_courses.json',
                'math_courses.json',
                'science_courses.json',
                'social_study_courses.json', // Use the user's filename
                'lote_courses.json',
                'art_courses.json',         // Use the user's filename
                'pe_courses.json',
                'cte_elective_courses.json',// Use the user's filename
                'elective_courses.json'     // Use the user's filename
            ];
            setIsLoading(true); // Start loading
            setLoadingError(null); // Reset error

            try {
                const fetchPromises = files.map(file =>
                    fetch(file).then(response => {
                        if (!response.ok) {
                            // Provide more specific error info
                            throw new Error(`Failed to load ${file}: ${response.status} ${response.statusText}`);
                        }
                        return response.json();
                    })
                );

                const results = await Promise.all(fetchPromises);
                const combinedCourses = results.flat(); // Combine arrays from all files
                setAllCoursesData(combinedCourses); // Store combined data in state
                console.log("Course data loaded successfully:", combinedCourses.length, "courses");
            } catch (error) {
                console.error("Failed to load course data:", error);
                // Set a user-friendly error message
                setLoadingError(`Error loading course data: ${error.message}. Check console and ensure JSON files exist and are accessible.`);
                setAllCoursesData([]); // Ensure data is cleared on error
            } finally {
                setIsLoading(false); // Finish loading (success or fail)
            }
        };

        fetchCourseData();
    }, []); // Empty dependency array means this runs once when the component mounts


    // --- Utility Functions (Defined within App to access state/props easily) ---

    // Finds a course object by its ID using the loaded data
    const findCourseById = useCallback((id) => {
        return allCoursesData.find(course => course.id === id);
    }, [allCoursesData]); // Dependency: Recreate if course data changes

    // Checks if prerequisites for a course are met
    // Now accepts allCoursesData as an argument
    const checkPrerequisites = useCallback((courseId, selectedCoursesByYear, middleSchoolCredits = [], targetYear, coursesData) => {
        const course = coursesData.find(c => c.id === courseId); // Find course in passed data
        if (!course || !course.prerequisites || course.prerequisites.length === 0) {
            return { met: true, message: '' };
        }

        const completedCourseIds = new Set([
            ...middleSchoolCredits,
            ...Object.entries(selectedCoursesByYear)
                .filter(([year]) => parseInt(year) < targetYear)
                .flatMap(([, courses]) => courses)
        ]);

        let prerequisitesMet = true;
        let unmetMessages = [];
        const requiredSets = course.prerequisites.map(prereq => prereq.split('||').map(s => s.trim()));

        for (const reqSet of requiredSets) {
            const metThisSet = reqSet.some(reqId => completedCourseIds.has(reqId));
            if (!metThisSet) {
                prerequisitesMet = false;
                // Use findCourseById (which uses allCoursesData state) for names
                const courseNames = reqSet.map(id => findCourseById(id)?.name || id).join(' OR ');
                unmetMessages.push(`Requires ${courseNames}`);
            }
        }

        // Simplified Co-requisite check (warning only)
        if (course.coRequisites && course.coRequisites.length > 0) {
            const currentYearCourses = new Set(selectedCoursesByYear[targetYear] || []);
            const metCoReqs = course.coRequisites.every(reqId => currentYearCourses.has(reqId));
             if (!metCoReqs && prerequisitesMet) {
                 const coReqNames = course.coRequisites.map(id => findCourseById(id)?.name || id).join(', ');
                 unmetMessages.push(`(Co-requisite suggested: ${coReqNames} in the same year)`);
             }
        }

        return { met: prerequisitesMet, message: unmetMessages.join('. ') };
    }, [findCourseById]); // Dependency: findCourseById (which depends on allCoursesData)

    // Calculates credits earned per subject
    // Now accepts allCoursesData as an argument
    const calculateCredits = useCallback((selectedCoursesByYear, middleSchoolCredits = [], coursesData) => {
        const credits = { ELA: 0, Math: 0, Science: 0, SocialStudies: 0, LOTE: 0, FineArts: 0, PE: 0, Electives: 0, Total: 0 };
        const uniqueCourseIds = new Set();
        const allCourseIds = [...middleSchoolCredits, ...Object.values(selectedCoursesByYear).flat()];

        allCourseIds.forEach(courseId => {
            if (uniqueCourseIds.has(courseId)) return;

            const course = coursesData.find(c => c.id === courseId); // Find in passed data
            if (course) {
                uniqueCourseIds.add(courseId);
                const subjectCategory = subjectMap[course.subject] || 'Electives';
                let credited = false;
                const maxRequired = graduationPlansData.dla.requirements[subjectCategory] || 0;

                // LOTE Substitution
                if (course.endorsements?.includes('LOTE Sub') && credits.LOTE < graduationPlansData.dla.requirements.LOTE) {
                     credits.LOTE += course.credits;
                     credited = true;
                }
                // Apply to primary subject if needed
                else if (subjectCategory !== 'Electives' && credits[subjectCategory] < maxRequired) {
                     const creditToAdd = Math.min(course.credits, maxRequired - credits[subjectCategory]);
                     credits[subjectCategory] += creditToAdd;
                     const remainingCredit = course.credits - creditToAdd;
                     if (remainingCredit > 0) credits.Electives += remainingCredit;
                     credited = true;
                }
                // Apply to Electives if not credited elsewhere
                if (!credited) {
                     credits.Electives += course.credits;
                }
                 credits.Total += course.credits;
            }
        });
        return credits;
    }, []); // No direct state dependencies here, but uses data passed in


    // --- Callbacks ---

    // Add course to a specific HS year
    const addCourse = useCallback((year, courseId) => {
        if (middleSchoolCredits.includes(courseId)) {
            setWarnings(prev => [...new Set([...prev, `${findCourseById(courseId)?.name || courseId} was already added as a Middle School credit.`])]);
            return;
        }
        setSelectedCourses(prev => {
            const yearCourses = prev[year] || [];
            if (!yearCourses.includes(courseId)) {
                return { ...prev, [year]: [...yearCourses, courseId] };
            }
            return prev;
        });
         const courseName = findCourseById(courseId)?.name || courseId;
         setWarnings(prev => prev.filter(w => !w.includes(`Prerequisite check for ${courseName}`)));
         setWarnings(prev => prev.filter(w => !w.includes(`Co-requisite suggested for ${courseName}`)));
    }, [middleSchoolCredits, findCourseById]);

    // Remove course from a specific HS year
    const removeCourse = useCallback((year, courseId) => {
        setSelectedCourses(prev => ({
            ...prev,
            [year]: (prev[year] || []).filter(id => id !== courseId)
        }));
    }, []);

     // Add a course credit earned in Middle School
     const addMiddleSchoolCredit = useCallback((courseId) => {
         const alreadyInHS = Object.values(selectedCourses).flat().includes(courseId);
         if (alreadyInHS) {
             setWarnings(prev => [...new Set([...prev, `${findCourseById(courseId)?.name || courseId} is already selected in your High School plan.`])]);
             return;
         }
         setMiddleSchoolCredits(prev => {
             if (!prev.includes(courseId)) {
                 return [...prev, courseId];
             }
             return prev;
         });
     }, [selectedCourses, findCourseById]);

      // Remove a course credit earned in Middle School
     const removeMiddleSchoolCredit = useCallback((courseId) => {
         setMiddleSchoolCredits(prev => prev.filter(id => id !== courseId));
     }, []);

     const clearWarnings = useCallback(() => {
         setWarnings([]);
     }, []);

    // Memoized calculation for display data (depends on loaded courses)
    const displayData = useMemo(() => {
        const planDetails = graduationPlansData[selectedPlanType];
        // Pass allCoursesData to calculateCredits
        const credits = calculateCredits(selectedCourses, middleSchoolCredits, allCoursesData);
        return { credits, planDetails };
    }, [selectedPlanType, selectedCourses, middleSchoolCredits, allCoursesData, calculateCredits]); // Add dependencies

    // PNG Export Handler
    const handleExportPNG = useCallback(() => {
        console.log("Export button clicked");
        const exportContent = document.getElementById('plan-export-content');
        if (exportContent && typeof window.html2canvas === 'function') {
            console.log("html2canvas function found, attempting render...");
            exportContent.classList.add('exporting-png'); // Add class for styling during export
            setTimeout(() => { // Timeout allows styles to apply briefly
                window.html2canvas(exportContent, {
                    scale: 2,
                    useCORS: true,
                    logging: true,
                    backgroundColor: '#f9fafb', // Ensure background color is set
                 }).then(canvas => {
                    console.log("html2canvas generated canvas");
                    const image = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.download = `RRISD_Graduation_Plan_${displayData.planDetails?.name?.replace(/\s+/g, '_') || 'Plan'}.png`;
                    link.href = image;
                    link.click();
                    console.log("Download triggered.");
                    exportContent.classList.remove('exporting-png'); // Remove class after export
                }).catch(err => {
                    console.error("Error generating PNG:", err);
                    setWarnings(prev => [...new Set([...prev, `Error generating PNG: ${err.message}. Check console.`])]);
                    exportContent.classList.remove('exporting-png');
                });
            }, 100); // Small delay
        } else if (!exportContent){
            console.error("Export content area 'plan-export-content' not found");
            setWarnings(prev => [...new Set([...prev, "Could not find content to export."])]);
        } else {
             console.error("html2canvas is not loaded or not a function.");
             setWarnings(prev => [...new Set([...prev, "PNG Export library (html2canvas) not loaded. Please wait or check console."])]);
        }
    }, [displayData.planDetails?.name, setWarnings]); // Dependencies

    // --- Render Logic ---

     // 1. Handle Client-Side Only Rendering Check
     if (!isClient) {
         return <div className="container mx-auto p-4 font-sans text-center">Initializing Planner...</div>;
     }

     // 2. Handle Loading State for Course Data
     if (isLoading) {
         return <div className="container mx-auto p-4 text-center">Loading course data...</div>;
     }

     // 3. Handle Course Data Loading Error
     if (loadingError) {
         return <div className="container mx-auto p-4 text-center text-red-600 border border-red-300 bg-red-50 rounded p-4">
             <h2 class="text-lg font-semibold mb-2">Error Loading Data</h2>
             <p>{loadingError}</p>
             <p class="mt-2 text-sm text-gray-700">Please ensure all JSON course files are in the same directory as this HTML file and are correctly formatted. You may need to run a local web server.</p>
          </div>;
     }

     // 4. Render the Main Application UI (if client-side, not loading, no errors)
    return (
        <div className="container mx-auto p-4 font-sans">
            {/* Wrapper for PNG export content */}
            <div id="plan-export-content" className="bg-gray-50 p-4 rounded-lg">
                <header className="mb-6 text-center">
                    <h1 className="text-3xl font-bold text-blue-700">RRISD 4-Year Graduation Planner</h1>
                    <p className="text-gray-600">Plan your high school journey!</p>
                    <p className="text-xs text-red-600 mt-1">Disclaimer: Uses representative data. Always consult official RRISD resources and your counselor.</p>
                </header>

                {/* Middle School Credits Section - Pass necessary props */}
                <MiddleSchoolCredits
                    middleSchoolCredits={middleSchoolCredits}
                    addMiddleSchoolCredit={addMiddleSchoolCredit}
                    removeMiddleSchoolCredit={removeMiddleSchoolCredit}
                    allCourses={allCoursesData} // Pass loaded data
                    findCourseById={findCourseById} // Pass helper
                />

                <div className="mb-6 p-4 bg-gray-50 rounded-lg shadow flex flex-wrap justify-between items-center gap-4">
                    <div>
                        <label htmlFor="plan-select" className="block text-sm font-medium text-gray-700 mb-1">Select Graduation Plan:</label>
                        <select
                            id="plan-select"
                            value={selectedPlanType}
                            onChange={(e) => setSelectedPlanType(e.target.value)}
                            className="w-full md:w-auto p-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            {Object.entries(graduationPlansData).map(([key, plan]) => (
                                <option key={key} value={key}>{plan.name} ({plan.totalCredits} Credits)</option>
                            ))}
                        </select>
                    </div>
                     {/* PNG Export Button */}
                     <button
                         onClick={handleExportPNG}
                         disabled={isLoading || !!loadingError} // Disable if loading or error
                         className={`px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 transition duration-150 ease-in-out ${isLoading || !!loadingError ? 'opacity-50 cursor-not-allowed' : ''}`}
                     >
                         Export Plan to PNG
                     </button>
                </div>

                {/* Year Plans - Pass necessary props */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    {[9, 10, 11, 12].map(year => (
                        <YearPlan
                            key={year}
                            year={year}
                            selectedCoursesInYear={selectedCourses[year] || []}
                            allCourses={allCoursesData} // Pass loaded data
                            middleSchoolCredits={middleSchoolCredits}
                            selectedCoursesByYear={selectedCourses}
                            addCourse={addCourse}
                            removeCourse={removeCourse}
                            setWarnings={setWarnings}
                            findCourseById={findCourseById} // Pass helper
                            checkPrerequisites={checkPrerequisites} // Pass helper
                        />
                    ))}
                </div>

                {/* Progress Trackers - Pass necessary props */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div className="md:col-span-1">
                        <GraduationProgress credits={displayData.credits} plan={displayData.planDetails} />
                    </div>
                    <div className="md:col-span-1">
                        <EndorsementTracker selectedCoursesByYear={selectedCourses} middleSchoolCredits={middleSchoolCredits} planType={selectedPlanType} />
                    </div>
                    <div className="md:col-span-1">
                        <DLAGuidance
                            selectedCoursesByYear={selectedCourses}
                            middleSchoolCredits={middleSchoolCredits}
                            planType={selectedPlanType}
                            findCourseById={findCourseById} // Pass helper
                        />
                    </div>
                </div>
            </div> {/* End of plan-export-content */}

             {/* Warnings Message Box */}
             <MessageBox messages={warnings} clearMessages={clearWarnings} />

             <footer className="text-center mt-8 text-xs text-gray-500">
                 Data loaded dynamically. Consult official RRISD sources.
             </footer>
        </div>
    );
}

// Render the App component to the DOM
const container = document.getElementById('root');
const root = ReactDOM.createRoot(container);
root.render(<App />);

    </script>
</body>
</html>
